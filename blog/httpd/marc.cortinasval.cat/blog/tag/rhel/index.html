<!DOCTYPE html>
<html lang="ca">
<head>
<title>rhel | El blog d&#039;en Marc</title>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type='text/javascript'>window.mod_pagespeed_start = Number(new Date());</script><link rel="profile" href="http://gmpg.org/xfn/11"/>
<link rel="pingback" href="https://marc.cortinasval.cat/blog/xmlrpc.php"/>
<link rel="alternate" type="application/rss+xml" title="El blog d&#039;en Marc &raquo; Feed" href="https://marc.cortinasval.cat/blog/ca/feed/"/>
<link rel="alternate" type="application/rss+xml" title="El blog d&#039;en Marc &raquo; Comments Feed" href="https://marc.cortinasval.cat/blog/ca/comments/feed/"/>
<link rel="alternate" type="application/rss+xml" title="El blog d&#039;en Marc &raquo; rhel Tag Feed" href="https://marc.cortinasval.cat/blog/tag/rhel/feed/"/>
<link rel='stylesheet' id='gsc_style-css' href='https://marc.cortinasval.cat/blog/wp-content/plugins/google-custom-search/css/smoothness/jquery-ui.theme.min.css?ver=4.1.1' type='text/css' media='all'/>
<link rel='stylesheet' id='gsc_style_search_bar-css' href='https://www.google.com/cse/style/look/minimalist.css?ver=4.1.1' type='text/css' media='all'/>
<link rel='stylesheet' id='gsc_style_search_bar_more-css' href='https://marc.cortinasval.cat/blog/wp-content/plugins/google-custom-search/css/gsc.css?ver=4.1.1' type='text/css' media='all'/>
<link rel='stylesheet' id='franklin_source_sans-css' href='//fonts.googleapis.com/css?family=Source+Sans+Pro%3A400%2C700%2C900&#038;ver=4.1.1' type='text/css' media='all'/>
<link rel='stylesheet' id='franklin_open_sans-css' href='//fonts.googleapis.com/css?family=Open+Sans%3A400%2C600&#038;ver=4.1.1' type='text/css' media='all'/>
<link rel='stylesheet' id='franklin_bootstrap_css-css' href='https://marc.cortinasval.cat/blog/wp-content/themes/franklin/assets/css/bootstrap.min.css?ver=4.1.1' type='text/css' media='all'/>
<link rel='stylesheet' id='franklin_style-css' href='https://marc.cortinasval.cat/blog/wp-content/themes/franklin/style.css?ver=4.1.1' type='text/css' media='all'/>
<link rel='stylesheet' id='custom-style-css' href='https://marc.cortinasval.cat/blog/wp-content/themes/franklin/assets/css/custom.css?ver=4.1.1' type='text/css' media='all'/>
<style id='custom-style-inline-css'>header,.widget_tag_cloud a:hover,.sticky-img,#primary-menu li ul li{background-color:#20b2aa}a:hover,#primary-menu li:hover a{color:#20b2aa}</style>
<!-- This site uses the Google Analytics by Yoast plugin v5.3.3 - Universal enabled - https://yoast.com/wordpress/plugins/google-analytics/ -->
<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','__gaTracker');__gaTracker('create','UA-26821552-3','auto');__gaTracker('set','forceSSL',true);__gaTracker('send','pageview');</script>
<!-- / Google Analytics by Yoast -->
<script src='https://marc.cortinasval.cat/blog/wp-includes/js/jquery/jquery.js?ver=1.11.1'></script>
<script src='https://marc.cortinasval.cat/blog/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<script src='https://marc.cortinasval.cat/blog/wp-content/plugins/google-custom-search/js/gsc.js?ver=4.1.1'></script>
<script src='https://www.google.com/jsapi?ver=4.1.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://marc.cortinasval.cat/blog/xmlrpc.php?rsd"/>
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://marc.cortinasval.cat/blog/wp-includes/wlwmanifest.xml"/>
<meta name="generator" content="WordPress 4.1.1"/>
<script>var _gaq=_gaq||[];_gaq.push(['_setAccount','UA-0000000-0']);_gaq.push(['_trackPageview']);(function(){var ga=document.createElement('script');ga.type='text/javascript';ga.async=true;ga.src=('https:'==document.location.protocol?'https://ssl':'http://www')+'.google-analytics.com/ga.js';var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(ga,s);})();</script>
<link rel="stylesheet" href="https://marc.cortinasval.cat/blog/wp-content/plugins/multi-column-tag-map/mctagmap.css?mctm_ver=12.0.4" type="text/css" media="screen"/>
<!--[if lt IE 9]><script src="https://marc.cortinasval.cat/blog/wp-content/themes/franklin/assets/js/html5shiv.js"></script><![endif]--><style id="syntaxhighlighteranchor"></style>
<script pagespeed_no_defer="">//<![CDATA[
(function(){var c=encodeURIComponent,g=window,h="performance";g.pagespeed=g.pagespeed||{};var l=g.pagespeed,m=function(f,a,d,b){this.c=f;this.a=a;this.b=d;this.d=b};l.beaconUrl="";
var n=function(f){var a=f.c,d=g.mod_pagespeed_start,b=Number(new Date)-d,a=a+(-1==a.indexOf("?")?"?":"&"),a=a+"ets="+("load"==f.a?"load:":"unload:"),a=a+b;if("beforeunload"!=f.a||!g.mod_pagespeed_loaded){a+="&r"+f.a+"=";if(g[h]){var b=g[h].timing,e=b.navigationStart,k=b.requestStart,a=a+(b[f.a+"EventStart"]-e),a=a+("&nav="+(b.fetchStart-e)),a=a+("&dns="+(b.domainLookupEnd-b.domainLookupStart)),a=a+("&connect="+(b.connectEnd-b.connectStart)),a=a+("&req_start="+(k-e)),a=a+("&ttfb="+(b.responseStart-
k)),a=a+("&dwld="+(b.responseEnd-b.responseStart)),a=a+("&dom_c="+(b.domContentLoadedEventStart-e));g[h].navigation&&(a+="&nt="+g[h].navigation.type);e=-1;b.msFirstPaint?e=b.msFirstPaint:g.chrome&&g.chrome.loadTimes&&(e=Math.floor(1E3*g.chrome.loadTimes().firstPaintTime));e=e-k;0<=e&&(a+="&fp="+e)}else a+=b;l.getResourceTimingData&&g.parent==g&&(a+=l.getResourceTimingData());a+=g.parent!=g?"&ifr=1":"&ifr=0";"load"==f.a&&(g.mod_pagespeed_loaded=!0,(b=g.mod_pagespeed_num_resources_prefetched)&&(a+=
"&nrp="+b),(b=g.mod_pagespeed_prefetch_start)&&(a+="&htmlAt="+(d-b)));l.panelLoader&&(d=l.panelLoader.getCsiTimingsString(),""!=d&&(a+="&b_csi="+d));l.criticalCss&&(d=l.criticalCss,a+="&ccis="+d.total_critical_inlined_size+"&cces="+d.total_original_external_size+"&ccos="+d.total_overhead_size+"&ccrl="+d.num_replaced_links+"&ccul="+d.num_unreplaced_links);""!=f.b&&(a+=f.b);document.referrer&&(a+="&ref="+c(document.referrer));a+="&url="+c(f.d);l.beaconUrl=a;(new Image).src=a}};
l.e=function(f,a,d,b){var e=new m(f,a,d,b);g.addEventListener?g.addEventListener(a,function(){n(e)},!1):g.attachEvent("on"+a,function(){n(e)})};l.addInstrumentationInit=l.e;})();

pagespeed.addInstrumentationInit('/mod_pagespeed_beacon', 'beforeunload', '', 'http://marc.cortinasval.cat/blog/tag/rhel/');
//]]></script></head>
<body class="archive tag tag-rhel tag-60">
<header role="banner">
<div id="top-bar" role="navigation">
<div class="container">
<div class="row">
<div id="site-description" class="col-xs-12 col-sm-12 col-md-12 col-lg-6">
<p>Tal com raja&#8230;.</p>
</div>
<div class="col-sm-12 col-md-12 col-lg-6">
<form id="header-search" role="search" class="search-form form-inline" action="https://marc.cortinasval.cat/blog/ca/">
<input type="search" class="search-field" value="" name="s"/>
<button type="submit"><span class="glyphicon glyphicon-search"></span></button>
</form>
</div>
</div>
</div>
</div>
<div id="bot-bar" class="container">
<div class="row">
<div id="logo" class="col-md-12 col-lg-3">
<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a href="https://marc.cortinasval.cat/blog/ca/" rel="home">El blog d&#039;en Marc</a>
</div>
<div id="primary-menu" class="col-md-12 col-lg-9" role="navigation">
<div class="collapse navbar-collapse">
<ul id="menu-principal" class="menu"><li id="menu-item-10" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-10"><a href="https://marc.cortinasval.cat/blog/category/sysadmin/">SysAdmin</a></li>
<li id="menu-item-11" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-11"><a href="https://marc.cortinasval.cat/blog/category/tecno/">Tecnologia</a></li>
<li id="menu-item-12" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-12"><a href="https://marc.cortinasval.cat/blog/category/varis/">Varis</a></li>
<li id="menu-item-239-en" class="lang-item lang-item-64 lang-item-en no-translation menu-item menu-item-type-custom menu-item-object-custom menu-item-239-en"><a href="https://marc.cortinasval.cat/blog/en/" hreflang="en"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAALCAIAAAD5gJpuAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAHzSURBVHjaYkxOP8IAB//+Mfz7w8Dwi4HhP5CcJb/n/7evb16/APL/gRFQDiAAw3JuAgAIBEDQ/iswEERjGzBQLEru97ll0g0+3HvqMn1SpqlqGsZMsZsIe0SICA5gt5a/AGIEarCPtFh+6N/ffwxA9OvP/7//QYwff/6fZahmePeB4dNHhi+fGb59Y4zyvHHmCEAAAW3YDzQYaJJ93a+vX79aVf58//69fvEPlpIfnz59+vDhw7t37968efP3b/SXL59OnjwIEEAsDP+YgY53b2b89++/awvLn98MDi2cVxl+/vl6mituCtBghi9f/v/48e/XL86krj9XzwEEEENy8g6gu22rfn78+NGs5Ofr16+ZC58+fvyYwX8rxOxXr169fPny+fPn1//93bJlBUAAsQADZMEBxj9/GBxb2P/9+S/R8u3vzxuyaX8ZHv3j8/YGms3w8ycQARmi2eE37t4ACCDGR4/uSkrKAS35B3TT////wADOgLOBIaXIyjBlwxKAAGKRXjCB0SOEaeu+/y9fMnz4AHQxCP348R/o+l+//sMZQBNLEvif3AcIIMZbty7Ly6t9ZmXl+fXj/38GoHH/UcGfP79//BBiYHjy9+8/oUkNAAHEwt1V/vI/KBY/QSISFqM/GBg+MzB8A6PfYC5EFiDAABqgW776MP0rAAAAAElFTkSuQmCC" title="English" alt="English"/>&nbsp;English</a></li>
</ul>	</div>
</div>
</div>
</div>
</header>
<div id="content" class="container"><div class="row" role="main">
<div class="col-md-8">
<article id="post-151" class="post-151 post type-post status-publish format-standard hentry category-sysadmin tag-centos tag-nginx tag-reverse-proxy tag-rhel tag-tuning">
<h3 class="post-title"><a href="https://marc.cortinasval.cat/blog/2013/08/05/afinem-rhelcentos-per-a-lnginxhaproxy-en-entorns-de-produccio/" rel="bookmark">Afinem RHEL/CentOs per a l&#8217;NGINX+HAPROXY en entorns de producció</a></h3><p>Per una banda, l&#8217;Nginx es un servidor WEB molt lleuger capaç de gestionar gran quantitat de connexions concurrents amb una eficaç gestió dels recursos, jo l&#8217;he utilitzat com a servidor proxy on he balancejat el tràfic de diferents aplicacions, tan en entorns productius com en entorns de desenvolupament. </p>
<p>D&#8217;una altra banda utilitzarem el HAPROXY com a balancejador, ja que és un dels programaris més potents, lleugers i flexibles a l&#8217;hora de balancejar tràfic, poden implementar-ho com a balancejador HTTP o TCP, en el meu cas, HTTP amb balanceig enganxós. <a href="hhttp://code.google.com/p/haproxy-docs/wiki/PerformanceTuning/">Per a aquest dimoni només he hagut d&#8217;afinar valors com tune.bufsize i tune.maxrewrite</a></p>
<p>En un entorn productiu cal afinar la plataforma per a tindre&#8217;ls preparats per a que ens permeti un bon rendiment, l&#8217;objectiu del post es tenir ben recopilada tota la informació que he utilitzat. Per la xarxa hi han molta documentació sobre aquest propòsit, aquí únicament els recopilarem per a tenir-ho ben recol·lectat, al final del post hi llisto les fonts.</p>
<p>CentOs/RHEL es la plataforma on ho he muntat, on el nginx únicament fa la funció de &#8220;reverse proxy&#8221; de diferents sites, descartant les funcionalitats de balanceig i de cache, on les he implementat amb HAProxy i Varnish-cache que ja he explicat <a href="http://marc.cortinasval.cat/blog/2013/03/19/balancejador-https-economic-nginxhaproxypacemaker/">en un altre post</a>, aquí amb vull centrar en afinar-ho i llistar els petits problemes que m&#8217;he trobat/corregit.</p>
<p>Per tal d&#8217;afinar-ho, segmentem 3 configuracions diferents:</p>
<ul>
<li>Paràmetres del nucli del sistema operatiu</li>
</ul>
<ul>
<li>Límits del sistema Operatiu</li>
</ul>
<ul>
<li>Configuració del nginx</li>
</ul>
<p><strong>Paràmetres del nucli del sistema operatiu</strong></p>
<p>Valor per defecte i aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_congestion_control = cubic
</pre>
<p>Algorisme de gestió dels trafic TCP, en el paràmetre net.ipv4.tcp_available_congestion_control podem saber quines opcions tenim carregades en el kernel de linux<br/>
En CentOs6 tenim aquestes opcions: cubic reno, en el següent enllaç ho explica<br/>
<a href="http://kaivanov.blogspot.com.es/2010/09/linux-tcp-tuning.html" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://kaivanov.blogspot.com.es/2010/09/linux-tcp-tuning.html', 'http://kaivanov.blogspot.com.es/2010/09/linux-tcp-tuning.html');">http://kaivanov.blogspot.com.es/2010/09/linux-tcp-tuning.html</a></p>
<ul>
<li>reno: Traditional TCP used by almost all other OSes. (default)</li>
<li>cubic: CUBIC-TCP (NOTE: There is a cubic bug in the Linux 2.6.18 kernel used by Redhat Enterprise Linux 5.3 and Scientific Linux 5.3. Use 2.6.18.2 or higher!)</li>
<li>bic: BIC-TCP</li>
<li>htcp: Hamilton TCP</li>
<li>vegas: TCP Vegas</li>
<li>westwood: optimized for lossy networks</li>
</ul>
<p>Valor per defecte i aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_window_scaling = 1
</pre>
<p>Auto-escalat de la mida de la finestra de recepció TCP utilitzat, la finestra més gran pot ocupar 65,535 bytes. 1 ho activem i 0 ho desactivem.</p>
<p>Valor per defecte:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.ip_local_port_range=&quot;32768 61000&quot;
</pre>
<p>Valor per aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.ip_local_port_range=&quot;2000 65000&quot;
</pre>
<p>Defineix el conjunt de ports locals que fa servir el SO per connexions les connexions TCP i UDP</p>
<p>Valor per defecte:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_max_syn_backlog=&quot;2048&quot;
</pre>
<p>Valor per aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_max_syn_backlog=&quot;204800&quot;
</pre>
<p>Numero màxim de peticions per les connexions rebudes que encara no ha rebut el ACK del emissor, per defecte és 1024 i en sistemes de menys de 128Mb li assignem 128. Si el servidor pateix sobrecàrrega intenta incrementar aquest valor.</p>
<p>Valor per defecte:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.core.somaxconn=&quot;128&quot;&quot;
</pre>
<p>Valor per aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.core.somaxconn=&quot;12800&quot;
</pre>
<p>Numero màxim de connexions que estan passant de LISTEN a ESTABLISHED, si es supera aquest número de connexions establertes el sistema les rebutja.</p>
<p>Valor per defecte:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_max_tw_buckets=&quot;262144&quot;
</pre>
<p>Valor per aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_max_tw_buckets=&quot;524284&quot;
</pre>
<p>Numero màxim de connexions en estat TIME_WAIT, quant el superem, el sistema elimina els sockets i envia un avís. Aquest limit només s&#8217;utilitza per AVISAR de atacs DDOS. Aquest valor no s&#8217;acostuma a baixar sinó a incrementar proporcionalment amb la memòria, si les condicions de xarxa aixi ho requereixen.</p>
<p>Valor per defecte:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.core.rmem_default=&quot;229376&quot;
</pre>
<p>Valor per aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.core.rmem_default=&quot;262142&quot;
</pre>
<p>Mida de la memòria asignada per defecte en la recepció pels socket</p>
<p>Valor per defecte:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.core.rmem_max=&quot;131071&quot;
</pre>
<p>Valor per aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.core.rmem_max=&quot;524284&quot;
</pre>
<p>Mida màxima de memòria assignada per defecte en la recepció pels socket, <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Performance_Tuning_Guide/s-network-dont-adjust-defaults.html" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Performance_Tuning_Guide/s-network-dont-adjust-defaults.html', 'aquest valor ha de ser superior al net.core.rmem_default');">aquest valor ha de ser superior al net.core.rmem_default</a><br/>
Alerta! En RHEL compleix aquesta ultima recomanació però en CentOS6 no ho segueix</p>
<p>Valor per defecte:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.core.wmem_default=&quot;229376&quot;
</pre>
<p>Valor per aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.core.wmem_default=&quot;262142
</pre>
<p>Mida de memòria asignada per defecte en l&#8217;enviament pels socket</p>
<p>Valor per defecte:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.core.wmem_max=&quot;131071&quot;
</pre>
<p>Valor per aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.core.wmem_max=&quot;524284&quot;
</pre>
<p>Mida màxima de memòria assignada per defecte en la emissió pels socket, <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Performance_Tuning_Guide/s-network-dont-adjust-defaults.html" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Performance_Tuning_Guide/s-network-dont-adjust-defaults.html', 'aquest valor ha de ser superior al net.core.rmem_default');">aquest valor ha de ser superior al net.core.rmem_default</a><br/>
Alerta! En RHEL compleix aquesta ultima recomanació però en CentOS6 no ho segueix</p>
<p>Valor per defecte i aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_rmem=&quot;4096 87380 4194304&quot;
</pre>
<p>Paràmetres de auto configuració TCP en la recepció de dades: El primer valor es la mida mínima de memòria utilitzat per a cada connexió TCP. El segon valor especifica la mida PER DEFECTE de buffer en la recepció per a cadascun dels socket. Aquest valor sobreescriu el /proc/sys/net/core/rmem_default utilitzat en altres protocols(!=TCP). El tercer i ultim valor especifica la mida màxima de memòria per la recepció de dades per a cadascun de les connexions TCP.</p>
<p>Valor per defecte i aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_wmem=&quot;4096 65536 4194304&quot;
</pre>
<p>Parametres de auto configuració TCP en la emissió: Aquests tres valors indiquen quin es l&#8217;espai de memòria assignat a cada socket en l&#8217;enviament de dades. El primer es la mida mínima, el segon la mida per defecte i el tercer la mida màxim del buffer reservat per a l&#8217;enviament de dades.</p>
<p>Valor per defecte:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_mem=&quot;753888 1005184 1507776&quot;
</pre>
<p>Valor per aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_mem=&quot;753888 1005184 4194304&quot;
</pre>
<p>Paràmetres de auto configuració TCP: Defineix com el sistema operatiu gestion l&#8217;ús de la memòria per a les connexions TCP. El primer valor especifica el umbral mínim. Per sota d&#8217;aquest valor el SO no va cap canvi de gestió de la memòria pels diferents socket TCP. El segons valor indica la mida per defecte permès per a 1a connexió TCP, el tercer valor ens indica la mida màxima de memòria utilitzat per les connexions TCP, si el SO consumeix més memòria per a les connexions TCP comença a fer DROPS de les noves connexions.</p>
<p>Valor per defecte i aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w fs.file-max=&quot;793779&quot;
</pre>
<p>Defineix el número màxim de descriptors de fitxers que gestiona el SO (Recordem que tant els sockets com els fitxers son descriptors de fitxers en entorns Linux/Unix)</p>
<p>Valor per defecte:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_tw_reuse=&quot;0&quot;
</pre>
<p>Valor per aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_tw_reuse=&quot;1&quot;
</pre>
<p>Permetre reutilitzar els sockets que estan en TIME_WAIT quant es segur des del punt de vista del protocol. Non hauria de ser modificat sense la supervisió d&#8217;un expert <img src="https://marc.cortinasval.cat/blog/wp-includes/images/smilies/icon_wink.gif" alt=";)" class="wp-smiley"/></p>
<p>Valor per defecte:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_tw_recycle=&quot;0&quot;
</pre>
<p>Valor per aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_tw_recycle=&quot;1&quot;
</pre>
<p>Permetre la rapida reutilització de sockets en TIME_WAIT. Activant aquesta opcio no es recomenada si estas fent NAT. En canvi amb el HAPROXY es molt recomenable per baixar CONSIDERABLEMENT el numero de connexions en TIME_WAIT. Adjunto una captura de graphite on podem veure el canvi només aplicant aquesta variable.<br/>
<a href="https://marc.cortinasval.cat/blog/wp-content/uploads/2013/08/haproxy.png"><img src="https://marc.cortinasval.cat/blog/wp-content/uploads/2013/08/haproxy.png" alt="haproxy" width="579" height="304" class="aligncenter size-full wp-image-204"/></a></p>
<p>Valor per defecte:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_max_orphans=&quot;262144&quot;
</pre>
<p>Valor per aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_max_orphans=&quot;30000&quot;
</pre>
<p>Número màxim de TCP sockets orfans que no estan connectats a cap proces. Quant aquest numero s&#8217;excedeix, les connexions orfanes es resetejant i es notifica amb una alerta. Aquest limit existeix nomes per prevenir atacs de denegament de servei. Decrementar aquest valor no es aconsellable. Les condicions de xarxa poden requerir que incrementis el numero de orfans permesos, cadascun dels orfans poden ocupar aproximadament 64k de memoria NO-SWAPEJABLE. El valor per defecte es igual que el parametre NR_FILE del kernel, en 262144 en RHEL6/CentOS6, ajustat a la memoria del sistema.</p>
<p>Valor per defecte:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_synack_retries=&quot;5&quot;
</pre>
<p>Valor per aplicat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
sysctl -w net.ipv4.tcp_synack_retries=&quot;3&quot;
</pre>
<p>Número màxim de vegades que un segment SYN/ACK per a una connexio TCP passiva sera retransmitit. Aquest numero no pot excedir de 255.</p>
<p><strong>Límits del sistema Operatiu</strong><br/>
Amb concordança amb el últim paràmetre explicat en l&#8217;apartat anterior, hem de ampliar el numero de descriptors de fitxers que permetem realitzar al usuari que instancia el nginx, afegint les línies següents al fitxer /etc/security/limits.conf</p>
<pre class="brush: plain; title: ; notranslate" title="">
nginx       soft    nofile   10000
nginx       hard    nofile   30000
</pre>
<p><strong>Configuració del nginx</strong><br/>
No menys important que les configuracions de sistema són la configuració del nginx. </p>
<p>Primerament cal dimensionar la memòria i la CPU del sistema. Cal dimensionar assignant els valors correctes de worker_processes i worker_connections tenint en compte la formula: max clients = worker_processes * worker_connections/4. En el meu cas tenim més de 1200 connexions concurrents on tinc una maquina amb 8 vCPUs i 8GB de RAM, on he assignat:</p>
<pre class="brush: plain; title: ; notranslate" title="">
worker_processes  8;
events {
    worker_connections  1024;
}
</pre>
<p>Seguidament segons el tipus d&#8217;aplicacions que estiguem balancejant amb l&#8217;nginx, tenint en compte el número i el tipus d&#8217;aplicacions, les connexions concurrents que requereixen, la mida tant de les capçaleres com del cos, tant de les peticions com de les respostes, caldrà afinar els següents paràmetres.</p>
<pre class="brush: plain; title: ; notranslate" title="">
## Size Limits
  client_body_buffer_size     128K;
  client_header_buffer_size   8k;
  client_max_body_size          1M;
  large_client_header_buffers 8 32k;
## Timeouts
  client_body_timeout   60;
  client_header_timeout 60;
  expires               24h;
  keepalive_timeout     60 60;
  send_timeout          60;
  proxy_connect_timeout 60s; 
  proxy_read_timeout 120s;
  proxy_send_timeout 120s
## TCP options
  tcp_nodelay on;
  tcp_nopush  on;
## Proxy options
  proxy_buffering           on;
  proxy_buffers 16 16k;
  proxy_buffer_size 32k;
##Fix header too big http://forum.nginx.org/read.php?2,188352
  fastcgi_buffers 16 16k;
  fastcgi_buffer_size 32k;
</pre>
<p>Aquests paràmetres els utilitzo per a publicar aplicacions PHP i contingut estàtic on es connecten tot tipus de navegadors tan estacions de treball, ordinadors portàtils, dispositius mòbils com tabletes des de diferents proveïdors ADSL, 2G, 3G, 4G, WiMax, FTH, etc&#8230;. Remarco que no utilitzo la funció de cache del nginx.<br/>
Seguidament faig esmena de 2 problemes que m&#8217;he trobat amb les nostres aplicacions.</p>
<p>Per part del Nginx, si volem augmentar les mides de la capçalera que reben del frontal a més de 16kb, també s&#8217;ha de parametritzar el parametres fastcgi_buffers i fastcgi_buffer_size tal com ho reporten en el foro <a href="http://forum.nginx.org/read.php?2,188352" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://forum.nginx.org/read.php?2,188352', 'aquest link');">aquest link</a>, no li vaig trobar logica però va ser aplicar-ho i desapareixer.</p>
<p>Per part del Haproxy també hi han limitacions del tamany del buffsize, en Centos/RHEL els paquets compilats del repositori yum estan tots a 16kb, <a href="http://www.serverphorums.com/read.php?10,87343" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://www.serverphorums.com/read.php?10,87343', 'en el foro de HAPROXY trobem com recompilar-ho');">en el foro de HAPROXY trobem com recompilar-ho</a><br/>
Molt útil per corregir aquest tipus de errors: </p>
<pre class="brush: plain; title: ; notranslate" title="">
echo show errors | socat stdio unix-connect:&lt;path-to-socket&gt;
</pre>
<p>Les principals fonts que he seguit són:</p>
<p><a href="http://linux.die.net/man/7/tcp" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://linux.die.net/man/7/tcp', 'http://linux.die.net/man/7/tcp');">http://linux.die.net/man/7/tcp</a><br/>
<a href="http://dak1n1.com/blog/12-nginx-performance-tuning" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://dak1n1.com/blog/12-nginx-performance-tuning', 'http://dak1n1.com/blog/12-nginx-performance-tuning');">http://dak1n1.com/blog/12-nginx-performance-tuning</a><br/>
<a href="http://www.cyberciti.biz/faq/rhel-linux-install-nginx-as-reverse-proxy-load-balancer/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://www.cyberciti.biz/faq/rhel-linux-install-nginx-as-reverse-proxy-load-balancer/', 'http://www.cyberciti.biz/faq/rhel-linux-install-nginx-as-reverse-proxy-load-balancer/');">http://www.cyberciti.biz/faq/rhel-linux-install-nginx-as-reverse-proxy-load-balancer/</a><br/>
<a href="http://www.cyberciti.biz/faq/linux-unix-nginx-too-many-open-files" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://www.cyberciti.biz/faq/linux-unix-nginx-too-many-open-files', 'http://www.cyberciti.biz/faq/linux-unix-nginx-too-many-open-files');">http://www.cyberciti.biz/faq/linux-unix-nginx-too-many-open-files</a><br/>
<a href="http://www.exceliance.fr/sites/default/files/biblio/art-2006-making_applications_scalable_with_lb.pdf" onclick="__gaTracker('send', 'event', 'download', 'http://www.exceliance.fr/sites/default/files/biblio/art-2006-making_applications_scalable_with_lb.pdf');">http://www.exceliance.fr/sites/default/files/biblio/art-2006-making_applications_scalable_with_lb.pdf</a><br/>
<a href="http://comments.gmane.org/gmane.comp.web.haproxy/11145" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://comments.gmane.org/gmane.comp.web.haproxy/11145', 'http://comments.gmane.org/gmane.comp.web.haproxy/11145');">http://comments.gmane.org/gmane.comp.web.haproxy/11145</a></p>
<div class="post-meta clearfix post-meta-list">
<p class="author-date">
<span class="glyphicon glyphicon-user"></span> mcortinas
<span class="glyphicon glyphicon-calendar"></span> Agost 5, 2013
</p>
<p class="post-tags"><span class="glyphicon glyphicon-tags"></span><a href="https://marc.cortinasval.cat/blog/tag/centos/">centos</a> <span class="slash"> / </span><a href="https://marc.cortinasval.cat/blog/tag/nginx/">nginx</a> <span class="slash"> / </span><a href="https://marc.cortinasval.cat/blog/tag/reverse-proxy/">reverse proxy</a> <span class="slash"> / </span><a href="https://marc.cortinasval.cat/blog/tag/rhel/">rhel</a> <span class="slash"> / </span><a href="https://marc.cortinasval.cat/blog/tag/tuning/">tuning</a> <span class="slash"> / </span></p>
</div>
</article>
<hr class="post-divider">	<div class="page-links"></div>	</div>
<div id="primary-sidebar" class="col-md-4">
<aside id="gsc-widget-2" class="widget google custom search"><hr> <div id="cse-search-form90" style="width: 100%;">Loading</div>
<script>google.load('search','1',{language:'ca'});google.setOnLoadCallback(function(){var customSearchControl=new google.search.CustomSearchControl('');customSearchControl.setResultSetSize(google.search.Search.FILTERED_CSE_RESULTSET);var options=new google.search.DrawOptions();options.setSearchFormRoot('cse-search-form90');options.setAutoComplete(true);customSearchControl.draw('dialog',options);customSearchControl.setSearchCompleteCallback(this,CallBackDisplayDialog);},true);function CallBackDisplayDialog(result){jQuery('#dialog').dialog('open');}</script>
<!-- open dialog. For debug purposes
                    <p><a href="#" id="dialog_link" class="ui-state-default ui-corner-all"><span class="ui-icon ui-icon-newwin"></span>Open Dialog</a></p>
            -->
<div id="dialog" title="Resultat de la cerca">
<p></p>
</div>
</aside>	<aside id="recent-posts-2" class="widget widget_recent_entries"><hr>	<h4>Entrades recents</h4>	<ul>
<li>
<a href="https://marc.cortinasval.cat/blog/2015/01/12/elk-en-centos7/">ELK en CentOs7</a>
</li>
<li>
<a href="https://marc.cortinasval.cat/blog/2014/04/29/graphite-gran-recurs-per-graficar-sistemes/">Graphite: gran recurs per gràficar sistemes</a>
</li>
<li>
<a href="https://marc.cortinasval.cat/blog/2014/03/05/kibana-ens-ajuda-amb-els-logs-de-aws-cloudfront-i-waf-akamai/">Kibana ens ajuda amb els logs de AWS Cloudfront i WAF Akamai</a>
</li>
<li>
<a href="https://marc.cortinasval.cat/blog/2013/12/17/varnish-cache-un-molt-bon-aliat-per-a-la-web/">varnish-cache, un molt bon aliat per a la web</a>
</li>
<li>
<a href="https://marc.cortinasval.cat/blog/2013/12/15/breu-resum-de-la-nostra-historia/">breu resum de la nostra història</a>
</li>
</ul>
</aside><aside id="linkcat-0" class="widget widget_links"><hr><h4>Favorits</h4>
<ul class='xoxo blogroll'>
<li><a href="http://www.cloudadmins.org/" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://www.cloudadmins.org/', 'Cloudadmins');" title="News about building cloud-ready infrastructures">Cloudadmins</a></li>
<li><a href="http://www.tomas.cat/blog/" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://www.tomas.cat/blog/', 'El blog d&#039;en Tomas');">El blog d&#039;en Tomas</a></li>
<li><a href="http://maauso.com/" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://maauso.com/', 'El blog de Miguel');">El blog de Miguel</a></li>
<li><a href="http://www.entredevyops.es/" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://www.entredevyops.es/', 'Entre Dev y Ops');">Entre Dev y Ops</a></li>
<li><a href="http://highscalability.com/" onclick="__gaTracker('send', 'event', 'outbound-widget', 'http://highscalability.com/', 'High Scability');">High Scability</a></li>
<li><a href="https://groups.google.com/forum/?hl=es#!forum/puppet-users-barcelona" onclick="__gaTracker('send', 'event', 'outbound-widget', 'https://groups.google.com/forum/?hl=es#!forum/puppet-users-barcelona', 'Puppet Users BCN');">Puppet Users BCN</a></li>
</ul>
</aside>
<aside id="meta-3" class="widget widget_meta"><hr><h4>Admin</h4>	<ul>
<li><a href="https://marc.cortinasval.cat/blog/wp-login.php">Log in</a></li>
<li><a href="https://marc.cortinasval.cat/blog/ca/feed/"><abbr title="en anglès, Really Simple Syndication">RSS</abbr> de les entrades</a></li>
<li><a href="https://marc.cortinasval.cat/blog/ca/comments/feed/"><abbr title="en inglés, Really Simple Syndication">RSS</abbr> dels comentaris</a></li>
<li><a href="https://wordpress.org/" title="Funcionant amb el WordPress, plataforma semàntica de publicació personal de primer ordre.">WordPress.org</a></li>	</ul>
</aside></div></div>
</div>
<footer>
<div id="footer-bottom">
<div class="container">
<div class="row">
<div id="footer-meta" class="col-md-9">
<p>&copy; <a id="footer-site" href="https://marc.cortinasval.cat/blog/ca" title="El blog d&#039;en Marc">El blog d&#039;en Marc</a></p>
</div>
<div id="footer-credit" class="col-md-3">
<p><a href="http://www.wpmultiverse.com/themes/franklin/" title="Franklin WordPress Theme">Franklin Theme</a></p>
</div>
</div>
</div>
</div>
</footer>
<script src='https://marc.cortinasval.cat/blog/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.9b'></script>
<script src='https://marc.cortinasval.cat/blog/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPlain.js?ver=3.0.9b'></script>
<script>(function(){var corecss=document.createElement('link');var themecss=document.createElement('link');var corecssurl="https://marc.cortinasval.cat/blog/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";if(corecss.setAttribute){corecss.setAttribute("rel","stylesheet");corecss.setAttribute("type","text/css");corecss.setAttribute("href",corecssurl);}else{corecss.rel="stylesheet";corecss.href=corecssurl;}document.getElementsByTagName("head")[0].insertBefore(corecss,document.getElementById("syntaxhighlighteranchor"));var themecssurl="https://marc.cortinasval.cat/blog/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.9b";if(themecss.setAttribute){themecss.setAttribute("rel","stylesheet");themecss.setAttribute("type","text/css");themecss.setAttribute("href",themecssurl);}else{themecss.rel="stylesheet";themecss.href=themecssurl;}document.getElementsByTagName("head")[0].insertBefore(themecss,document.getElementById("syntaxhighlighteranchor"));})();SyntaxHighlighter.config.strings.expandSource='+ expand source';SyntaxHighlighter.config.strings.help='?';SyntaxHighlighter.config.strings.alert='SyntaxHighlighter\n\n';SyntaxHighlighter.config.strings.noBrush='Can\'t find brush for: ';SyntaxHighlighter.config.strings.brushNotHtmlScript='Brush wasn\'t configured for html-script option: ';SyntaxHighlighter.defaults['pad-line-numbers']=false;SyntaxHighlighter.defaults['toolbar']=false;SyntaxHighlighter.all();</script>
<script src='https://marc.cortinasval.cat/blog/wp-includes/js/jquery/ui/core.min.js?ver=1.11.2'></script>
<script src='https://marc.cortinasval.cat/blog/wp-includes/js/jquery/ui/widget.min.js?ver=1.11.2'></script>
<script src='https://marc.cortinasval.cat/blog/wp-includes/js/jquery/ui/mouse.min.js?ver=1.11.2'></script>
<script src='https://marc.cortinasval.cat/blog/wp-includes/js/jquery/ui/resizable.min.js?ver=1.11.2'></script>
<script src='https://marc.cortinasval.cat/blog/wp-includes/js/jquery/ui/draggable.min.js?ver=1.11.2'></script>
<script src='https://marc.cortinasval.cat/blog/wp-includes/js/jquery/ui/button.min.js?ver=1.11.2'></script>
<script src='https://marc.cortinasval.cat/blog/wp-includes/js/jquery/ui/position.min.js?ver=1.11.2'></script>
<script src='https://marc.cortinasval.cat/blog/wp-includes/js/jquery/ui/dialog.min.js?ver=1.11.2'></script>
<script src='https://marc.cortinasval.cat/blog/wp-content/themes/franklin/assets/js/bootstrap.min.js?ver=3.1.1'></script>
<script src='https://marc.cortinasval.cat/blog/wp-content/themes/franklin/assets/js/franklin.js?ver=1.0'></script>
<script src='https://marc.cortinasval.cat/blog/wp-content/plugins/multi-column-tag-map/mctagmap.js?mctm_ver=12.0.4&#038;ver=1'></script>
<script>if(typeof console==='object'){console.log('[BEGIN WordPress HTTPS Debug Log]');console.log('Version: 3.3.6');console.log('HTTP URL: http://marc.cortinasval.cat/blog/');console.log('HTTPS URL: https://marc.cortinasval.cat/blog/');console.log('SSL: Yes');console.log('Diff Host: No');console.log('Subdomain: Yes');console.log('Proxy: Yes');console.log('Secure External URLs: [ https://secure.gravatar.com/avatar/42273633a4b1808ae44b549f7302a810?s=64&amp;d=https%3A%2F%2Fsecure.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D64&amp;r=G, https://secure.gravatar.com/avatar/42273633a4b1808ae44b549f7302a810?s=26&amp;d=https%3A%2F%2Fsecure.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D26&amp;r=G, https://secure.gravatar.com/avatar/6c87e23e43690cda892bef9999094abf?s=50&amp;d=https%3A%2F%2Fsecure.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D50&amp;r=G, https://secure.gravatar.com/avatar/ea7dbb10aac09a108d5cbf5c6c9ea21a?s=50&amp;d=https%3A%2F%2Fsecure.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D50&amp;r=G, https://secure.gravatar.com/avatar/4c530e5935bc75173f11e16a1436a8a8?s=50&amp;d=https%3A%2F%2Fsecure.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D50&amp;r=G, https://secure.gravatar.com/avatar/42273633a4b1808ae44b549f7302a810?s=50&amp;d=https%3A%2F%2Fsecure.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D50&amp;r=G, http://lh5.googleusercontent.com/-TZkI5pIXMd8/AAAAAAAAAAI/AAAAAAAAAAA/zQRIcpCZBSQ/photo.jpg, http://cdn.gtln.us/img/nxs/noImgC.png, http://www.google.com/cse/style/look/minimalist.css, http://www.google.com/jsapi, https://secure.gravatar.com/avatar/4c530e5935bc75173f11e16a1436a8a8?s=40&amp;d=https%3A%2F%2Fsecure.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D40&amp;r=G, https://secure.gravatar.com/avatar/42273633a4b1808ae44b549f7302a810?s=96&amp;d=https%3A%2F%2Fsecure.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D96&amp;r=G, https://www.google.com/jsapi, https://secure.gravatar.com/avatar/ea7dbb10aac09a108d5cbf5c6c9ea21a?s=40&amp;d=https%3A%2F%2Fsecure.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D40&amp;r=G, https://secure.gravatar.com/avatar/6c87e23e43690cda892bef9999094abf?s=40&amp;d=https%3A%2F%2Fsecure.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D40&amp;r=G, https://secure.gravatar.com/avatar/42273633a4b1808ae44b549f7302a810?s=40&amp;d=https%3A%2F%2Fsecure.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D40&amp;r=G ]');console.log('Unsecure External URLs: [  ]');console.log('[FIXED] Element: <a> - http://marc.cortinasval.cat/blog/wp-content/uploads/2013/08/haproxy.png => https://marc.cortinasval.cat/blog/wp-content/uploads/2013/08/haproxy.png');console.log('[FIXED] Element: <img> http://marc.cortinasval.cat/blog/wp-content/uploads/2013/08/haproxy.png => https://marc.cortinasval.cat/blog/wp-content/uploads/2013/08/haproxy.png');console.log('[END WordPress HTTPS Debug Log]');}</script>
<script pagespeed_no_defer="">//<![CDATA[

pagespeed.addInstrumentationInit('/mod_pagespeed_beacon', 'load', '', 'http://marc.cortinasval.cat/blog/tag/rhel/');
//]]></script></body>
</html>	